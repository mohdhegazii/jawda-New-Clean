# تقرير فني: إضافة نظام "نوع العقار في السوق"

تم تنفيذ النظام الجديد بنجاح مع الالتزام الكامل بالمتطلبات. إليك ملخص للتغييرات الفنية:

### 1. تخزين البيانات (Database)

- **ما هو اسم الجدول؟**
  - لم يتم إنشاء جدول جديد. تم استخدام الجدول الحالي المخصص للـ Lookups وهو `wp_hegzz_unit_lookups` لضمان التوافقية وعدم إضافة جداول غير ضرورية.
- **كيف تم التمييز؟**
  - تم تمييز "أنواع العقار في السوق" باستخدام `group_key = 'market_type'` داخل الجدول.
- **الأعمدة المستخدمة:**
  - `id`, `group_key`, `slug`, `label_en`, `label_ar`, `is_active`.

### 2. كلاس الخدمة (Service Class)

- **ما هو اسم الكلاس؟**
  - `Hegzz_Market_Type_Service`
- **المسار:**
  - `app/inc/units/class-hegzz-market-type-service.php`
- **أهم الدوال:**
  - `create_market_type()`: لإنشاء نوع جديد.
  - `update_market_type()`: لتحديث نوع موجود.
  - `delete_market_type()`: لحذف نوع، وتتعامل تلقائيًا مع الحذف النهائي (Hard Delete) أو المؤقت (Soft Delete) بناءً على ما إذا كان النوع مرتبطًا بعقارات أم لا.
  - `get_linked_listings_count()`: لحساب عدد العقارات المرتبطة بنوع معين.

### 3. جلب البيانات (API Layer)

- **اسم الملف:**
  - تم تحديث الملف الحالي `app/inc/units/api.php`.
- **كيف يتم جلب البيانات؟**
  - عبر الدالة الجديدة `hegzz_get_market_types()`. هذه الدالة تستخدم نظام الكاش (WordPress Object Cache) لجلب البيانات بشكل سريع وفعال.

### 4. الربط مع الوحدات (Listings Integration)

- **ما هو الـ Meta Key؟**
  - يتم تخزين معرّف "نوع العقار في السوق" في الـ meta key التالي لكل وحدة: `_hegzz_market_type_id`.
- **كيف تم الربط؟**
  - تمت إضافة حقل `select` (قائمة منسدلة) في شاشة تعديل الوحدة (Listing) تحت تبويب "Property Details" لاختيار النوع.

### 5. شاشة الإدارة (Admin UI)

- **كيف يمكن للأدمن إدارة الأنواع؟**
  - من خلال القائمة الرئيسية **"Hegzz Lookups"**.
  - تمت إضافة **تبويب (Tab) جديد** باسم **"Market Types"** بجانب تبويبات Unit Lookups الحالية.
  - هذه الشاشة تتيح إضافة، تعديل، وحذف أنواع العقار في السوق.

### 6. عمود "عدد العقارات" والفلترة

- **كيف يعمل؟**
  - يقوم العمود في شاشة إدارة "Market Types" بعرض عدد العقارات المرتبطة بكل نوع.
  - هذا الرقم هو رابط (hyperlink) يوجه الأدمن إلى شاشة الوحدات (Listings).
  - الرابط يحتوي على باراميتر مخصص (`?hegzz_market_type_id=...`).
  - تم إضافة `hook` على `pre_get_posts` لفلترة الوحدات وعرض فقط تلك المرتبطة بالنوع المطلوب عند الضغط على الرابط.

### 7. تأكيد عدم المساس بالأنظمة الحالية

- أؤكد أنه **لم يتم إجراء أي تعديل** على الأنظمة التالية:
  - **نظام المواقع (Location system)**: لم يتم المساس بأي من جداوله، كلاساته، أو شاشاته.
  - **نظام Unit Lookups**: تم فقط إضافة `group_key` جديد دون التأثير على المجموعات الحالية.
  - **نظام Types & Categories**: لم يتم تعديل أي شيء يخصه.

النظام الجديد يعمل بشكل مستقل ومنعزل تمامًا عن الأنظمة الأخرى لضنا الاستقرار.
